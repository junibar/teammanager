<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Team Manager · Formation Board v8.5.2</title>
<link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml" />
<style>
  :root{ --bg:#0b111a; --panel:#121a24; --muted:#8aa0b6; --text:#e9eef6; --accent:#4da3ff; --pitch:#146c43; --line:#e6f3e9; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple Color Emoji","Segoe UI Emoji";}
  header{display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:12px 16px; border-bottom:1px solid #1b2531; background:#0e1522; position:sticky; top:0; z-index:3;}
  header h1{font-size:16px; margin:0 6px 0 0; font-weight:700; letter-spacing:.2px}
  .pill{padding:8px 10px; background:var(--panel); border:1px solid #1e2a37; border-radius:10px; display:flex; align-items:center; gap:8px}
  select,input{background:#0f1622; color:var(--text); border:1px solid #293748; border-radius:8px; padding:7px 9px; outline:none}
  select:focus,input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(77,163,255,.14)}
  button{ background:#162336; color:#e6f0ff; border:1px solid #2a3a54; border-radius:8px; padding:8px 12px; cursor:pointer; }
  button:hover{filter:brightness(1.08)} button.ghost{background:transparent; border-color:#3a4a61; color:#cfd9ee}
  button.warn{background:#3f2c00; border-color:#5d4300; color:#ffd98b} button.good{background:#063d2a; border-color:#0f6; color:#c1ffdf}
  main{display:grid; grid-template-columns: 1.05fr 880px; gap:14px; padding:14px} @media (max-width:1260px){ main{grid-template-columns:1fr} }
  .card{ background:var(--panel); border:1px solid #1c2633; border-radius:14px; overflow:hidden; }
  .card header{background:transparent; border-bottom:1px solid #1c2633; padding:10px 12px} .card header h2{font-size:14px; margin:0; opacity:.92}
  .card .body{padding:12px} .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .muted{color:var(--muted)} .sep{height:1px; background:#1c2633; margin:10px 0}
  table{width:100%; border-collapse:collapse; table-layout:fixed}
  th,td{border-bottom:1px dashed #263346; padding:6px 6px; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  th{font-weight:600; color:#cdd7e6} tr:hover td{background:#0f1722} td input, td select{width:100%}
  #pitchWrap{position:relative; aspect-ratio:105/68; background:var(--pitch); border:1px solid #0f422b; border-radius:14px; overflow:hidden}
  canvas{display:block; width:100%; height:100%}
  .drag{cursor:grab; user-select:none; color:#aab6c8} .drag:active{cursor:grabbing}
  .banner{background:#0f1b2b; border:1px solid #203149; color:#b7c8e6; padding:6px 10px; border-radius:10px; display:flex; align-items:center; gap:8px}
  .w-num{width:42px; text-align:center} .w-ovr{width:80px} .w-name{width:210px} .w-pos{width:120px} .w-first{width:110px} .w-type{width:220px} .w-del{width:40px; text-align:center}
  .typeWrap{display:flex; gap:6px; align-items:center} .emoji{width:52px}
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:50; }
  .modal .panel{ background:#0e1522; border:1px solid #263448; border-radius:14px; width:560px; max-width:92vw; padding:16px; }
  .grid{display:grid; grid-template-columns:130px 1fr; gap:10px 12px; align-items:center}
</style>
</head>
<body>
<header>
  <h1>Team Manager · Formation Board v8.5.2</h1>
  <div class="pill">
    <span class="muted">플레이어</span>
    <select id="playerSelect"><option>JUNIBAR</option><option>D0PAM1NE</option></select>
  </div>
  <div class="pill">
    <span class="muted">팀</span>
    <select id="teamSelect"></select>
    <button id="addTeamBtn">팀 추가</button>
    <button id="renameTeamBtn" class="ghost">이름 변경</button>
    <button id="deleteTeamBtn" class="warn">삭제</button>
  </div>
  <div class="pill">
    <button id="exportPngBtn">PNG 내보내기</button>
    <button id="exportJsonBtn" class="ghost">JSON 내보내기</button>
    <label class="pill small" for="importJsonInput" style="cursor:pointer">JSON 불러오기</label>
    <input id="importJsonInput" type="file" accept="application/json" style="display:none" />
  </div>
  <div class="pill">
    <button id="openSettingsBtn" class="ghost">GitHub 저장 설정</button>
    <button id="saveToGithubBtn" class="good" title="(Ctrl+S)">GitHub로 저장</button>
  </div>
  <div id="dataBanner" class="banner" style="margin-left:auto; display:none;">
    <span>📦</span><span id="dataBannerText"></span>
    <button id="reloadDataBtn" class="ghost" style="margin-left:8px;">데이터 다시 불러오기</button>
  </div>
</header>

<main>
  <section id="left" class="card">
    <header><h2>로스터</h2></header>
    <div class="body">
      <div class="row small"><span class="muted">구분 <b>FIRST/SUB</b>. 선발에서 <b>아이콘 ≤ 2</b>, <b>태극 ≤ 2</b>. 타입: 일반/아이콘/태극/아미고/퓨쳐. 기본 이모지: ⭐/🔹/🩶/💗</span></div>
      <div class="sep"></div>
      <table id="rosterTable">
        <thead>
          <tr>
            <th class="w-del">⇅</th><th class="w-num">번호</th><th class="w-name">이름</th><th class="w-ovr">OVR</th>
            <th class="w-pos">포지션</th><th class="w-first">구분</th><th class="w-type">선수 타입</th><th class="w-del">-</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="sep"></div>
      <div class="row"><button id="addPlayerBtn">선수 추가</button><button id="bulkAddBtn" class="ghost">대량 추가</button></div>
    </div>
  </section>

  <section id="center" class="card">
    <header><h2>전술 보드</h2></header>
    <div class="body">
      <div id="pitchWrap"><canvas id="pitch"></canvas></div>
      <div class="sep"></div>
      <div id="subsPanel">
        <div id="subsToolbar" style="display:flex; gap:8px; align-items:center; justify-content:flex-start; margin:0 0 8px 0;">
          <button id="saveBtn" class="good" title="(Ctrl+S)">저장</button>
          <button id="clearManualBtn" class="ghost">수동 위치 초기화</button>
          <button id="forceReflowBtn" class="ghost">강제 재배치</button>
        </div>
        <h3 style="margin:4px 0 8px 0; font-size:13px; color:#cdd7e6">SUB 명단 (최대 10명)</h3>
        <table id="subsTable">
          <thead><tr><th style="width:40%">이름</th><th style="width:20%">포지션</th><th style="width:20%">OVR</th><th style="width:20%">선수타입</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" aria-hidden="true">
  <div class="panel">
    <h3 style="margin:2px 0 12px 0">GitHub 저장 설정</h3>
    <div class="grid">
      <div class="muted">Owner</div><input id="ghOwner" placeholder="github-username" />
      <div class="muted">Repo</div><input id="ghRepo" placeholder="team-manager" />
      <div class="muted">Branch</div><input id="ghBranch" placeholder="main" value="main" />
      <div class="muted">Path</div><input id="ghPath" placeholder="data/default.json" value="data/default.json" />
      <div class="muted">Token (PAT)</div><input id="ghToken" placeholder="ghp_..." type="password" />
    </div>
    <div class="row" style="margin-top:12px; justify-content:flex-end">
      <button id="closeSettingsBtn" class="ghost">닫기</button>
      <button id="saveSettingsBtn" class="good">저장</button>
    </div>
    <p class="muted" style="margin-top:8px">토큰은 이 브라우저의 <code>localStorage</code>에만 저장됩니다.</p>
  </div>
</div>

<script>
// All logic in DOMContentLoaded for safe binding
document.addEventListener('DOMContentLoaded', () => {
  const TYPE_LABEL = { NORMAL:"일반", ICON:"아이콘", TAEGUEK:"태극", AMIGO:"아미고", FUTURE:"퓨쳐" };
  const LS_KEY = "tm_v8_5_2";
  const GH_KEY = "tm_v8_5_github";
  let dataSource = null;

  // helpers
  const qs = sel => document.querySelector(sel);
  const on = (el,ev,fn) => el && el.addEventListener(ev,fn);
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const groupByPos=(pos)=>{pos=(pos||"").toUpperCase();if(pos==="GK")return"GK";if(pos==="DF")return"DF";if(pos==="MF")return"MF";if(pos==="FW")return"FW";return"DF"};
  const spacedXs=(n,w)=>{w=clamp(w,0,82);const xs=[];const c=50,h=w/2;for(let i=0;i<n;i++){const t=(n===1)?0.5:i/(n-1);xs.push(Math.round((c-h)+w*t))}return xs};
  const safeParse=(j,f)=>{try{const v=JSON.parse(j);return v??f}catch{return f}};
  const getQuery=(n)=>{const u=new URL(location.href);return u.searchParams.get(n)};
  const downloadBlob=(blob,fn)=>{const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fn;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),1500)};
  const toast=(msg)=>{const d=document.createElement('div');d.textContent=msg;Object.assign(d.style,{position:'fixed',right:'14px',bottom:'14px',background:'#0f1b2b',border:'1px solid #203149',color:'#cfe3ff',padding:'8px 12px',borderRadius:'10px',zIndex:99});document.body.appendChild(d);setTimeout(()=>d.remove(),1500)};

  // state
  const defaultTeam={roster:[{name:"GK",pos:"GK",first:"FIRST",ovr:72,type:"NORMAL",emoji:""},{name:"RB",pos:"DF",first:"FIRST",ovr:70,type:"NORMAL",emoji:""},{name:"RCB",pos:"DF",first:"FIRST",ovr:70,type:"NORMAL",emoji:""},{name:"LCB",pos:"DF",first:"FIRST",ovr:70,type:"NORMAL",emoji:""},{name:"LB",pos:"DF",first:"FIRST",ovr:70,type:"NORMAL",emoji:""},{name:"RM",pos:"MF",first:"SUB",ovr:72,type:"NORMAL",emoji:""},{name:"CM",pos:"MF",first:"SUB",ovr:73,type:"ICON",emoji:"⭐"},{name:"LM",pos:"MF",first:"FIRST",ovr:72,type:"TAEGUEK",emoji:"🔹"},{name:"RF",pos:"FW",first:"SUB",ovr:74,type:"NORMAL",emoji:""},{name:"LF",pos:"FW",first:"SUB",ovr:74,type:"AMIGO",emoji:"🩶"},{name:"ST",pos:"FW",first:"FIRST",ovr:70,type:"FUTURE",emoji:"💗"}]};
  let state=null;
  function buildDefaultState(){return{players:{"JUNIBAR":{teams:{"TEAM A":JSON.parse(JSON.stringify(defaultTeam))},currentTeam:"TEAM A"},"D0PAM1NE":{teams:{"TEAM B":JSON.parse(JSON.stringify(defaultTeam))},currentTeam:"TEAM B"}},currentPlayer:"JUNIBAR"}}
  function loadAll(){return safeParse(localStorage.getItem(LS_KEY),null)}
  function saveAll(){localStorage.setItem(LS_KEY,JSON.stringify(state))}
  async function tryAutoLoad(){const o=getQuery("data");const cs=[o,"data/default.json"].filter(Boolean);for(const url of cs){try{const r=await fetch(url,{cache:"no-store"});if(!r.ok)continue;const js=await r.json();if(js&&js.players){localStorage.setItem(LS_KEY,JSON.stringify(js));dataSource=url;return js}}catch{}}return null}
  async function initState(){const needReload=getQuery("reload")==="1";let ls=loadAll();if(needReload||!ls){const f=await tryAutoLoad();if(f){state=f;return}}if(!ls){ls=buildDefaultState();localStorage.setItem(LS_KEY,JSON.stringify(ls))}state=ls}
  function ensureDefaults(){if(!state.players)state.players={};if(!state.players["JUNIBAR"])state.players["JUNIBAR"]={teams:{},currentTeam:null};if(!state.players["D0PAM1NE"])state.players["D0PAM1NE"]={teams:{},currentTeam:null};if(!state.currentPlayer||!state.players[state.currentPlayer])state.currentPlayer="JUNIBAR";for(const u of Object.keys(state.players)){const po=state.players[u];if(!po.teams||typeof po.teams!=="object")po.teams={};if(Object.keys(po.teams).length===0){po.teams["TEAM A"]=JSON.parse(JSON.stringify(defaultTeam));po.currentTeam="TEAM A"}if(!po.currentTeam||!po.teams[po.currentTeam])po.currentTeam=Object.keys(po.teams)[0]}}
  function currentPlayerObj(){return state.players[state.currentPlayer]}
  function currentTeamObj(){const p=currentPlayerObj();return p.teams[p.currentTeam]}

  // elements
  const el={
    playerSelect:qs("#playerSelect"), teamSelect:qs("#teamSelect"), addTeamBtn:qs("#addTeamBtn"), renameTeamBtn:qs("#renameTeamBtn"), deleteTeamBtn:qs("#deleteTeamBtn"),
    exportPngBtn:qs("#exportPngBtn"), exportJsonBtn:qs("#exportJsonBtn"), importJsonInput:qs("#importJsonInput"),
    openSettingsBtn:qs("#openSettingsBtn"), saveToGithubBtn:qs("#saveToGithubBtn"), reloadDataBtn:qs("#reloadDataBtn"),
    dataBanner:qs("#dataBanner"), dataBannerText:qs("#dataBannerText"),
    rosterTableBody:qs("#rosterTable tbody"), addPlayerBtn:qs("#addPlayerBtn"), bulkAddBtn:qs("#bulkAddBtn"),
    pitch:qs("#pitch"), saveBtn:qs("#saveBtn"), clearManualBtn:qs("#clearManualBtn"), forceReflowBtn:qs("#forceReflowBtn"),
    settingsModal:qs("#settingsModal"),
    ghOwner:qs("#ghOwner"), ghRepo:qs("#ghRepo"), ghBranch:qs("#ghBranch"), ghPath:qs("#ghPath"), ghToken:qs("#ghToken"),
    closeSettingsBtn:qs("#closeSettingsBtn"), saveSettingsBtn:qs("#saveSettingsBtn"),
  };
  const ctx = el.pitch.getContext("2d");

  // roster render
  function refreshRosterTable(){
    const t=currentTeamObj(); el.rosterTableBody.innerHTML="";
    (t.roster||[]).forEach((p,idx)=>{
      const tr=document.createElement("tr"); tr.draggable=true;
      tr.innerHTML=`<td class="drag w-del">≡</td><td class="w-num">${idx+1}</td><td class="w-name"><input type="text" value="${p.name??""}"></td><td class="w-ovr"><input type="number" min="1" max="99" value="${(p.ovr??70)}"></td><td class="w-pos"><select><option>GK</option><option>DF</option><option>MF</option><option>FW</option></select></td><td class="w-first"><select><option>FIRST</option><option>SUB</option></select></td><td class="w-type"><div class="typeWrap"><select class="ptypeSel"><option value="NORMAL">일반</option><option value="ICON">아이콘</option><option value="TAEGUEK">태극</option><option value="AMIGO">아미고</option><option value="FUTURE">퓨쳐</option></select><input class="emoji" type="text" maxlength="2" placeholder="⭐/🔹/🩶/💗"/></div></td><td class="w-del"><button class="ghost">-</button></td>`;
      const nameEl=tr.children[2].firstElementChild, ovrEl=tr.children[3].firstElementChild, posSel=tr.children[4].firstElementChild, firstSel=tr.children[5].firstElementChild;
      const typeSel=tr.querySelector(".ptypeSel"), emojiEl=tr.querySelector(".emoji"), delBtn=tr.children[7].firstElementChild;
      posSel.value=p.pos||"DF"; firstSel.value=p.first||"SUB"; typeSel.value=p.type||"NORMAL";
      if(!p.emoji){ if(p.type==="ICON")p.emoji="⭐"; else if(p.type==="TAEGUEK")p.emoji="🔹"; else if(p.type==="AMIGO")p.emoji="🩶"; else if(p.type==="FUTURE")p.emoji="💗"; }
      emojiEl.value=p.emoji||""; emojiEl.style.display=(["ICON","TAEGUEK","AMIGO","FUTURE"].includes(typeSel.value))?"block":"none";
      on(nameEl,"input",()=>{p.name=nameEl.value;saveAll();draw()});
      on(ovrEl,"change",()=>{p.ovr=Math.max(1,Math.min(99,Number(ovrEl.value)||70));saveAll();draw()});
      on(posSel,"change",()=>{p.pos=posSel.value;saveAll();draw()});
      on(firstSel,"change",()=>{p.first=firstSel.value;saveAll();draw()});
      on(typeSel,"change",()=>{p.type=typeSel.value;if(typeSel.value==="ICON"&&!p.emoji)p.emoji="⭐";if(typeSel.value==="TAEGUEK"&&!p.emoji)p.emoji="🔹";if(typeSel.value==="AMIGO"&&!p.emoji)p.emoji="🩶";if(typeSel.value==="FUTURE"&&!p.emoji)p.emoji="💗";emojiEl.style.display=(["ICON","TAEGUEK","AMIGO","FUTURE"].includes(typeSel.value))?"block":"none";emojiEl.value=p.emoji||"";saveAll();draw()});
      on(emojiEl,"input",()=>{p.emoji=emojiEl.value;saveAll();draw()});
      on(delBtn,"click",()=>{t.roster.splice(idx,1);refreshRosterTable();saveAll();draw()});
      on(tr,"dragstart",(e)=>{e.dataTransfer.setData("text/plain", String(idx));tr.style.opacity=.5});
      on(tr,"dragend",()=>{tr.style.opacity=""});
      on(tr,"dragover",(e)=>{e.preventDefault();tr.style.outline="1px dashed #3a4a66"});
      on(tr,"dragleave",()=>{tr.style.outline=""});
      on(tr,"drop",(e)=>{e.preventDefault();tr.style.outline="";const from=Number(e.dataTransfer.getData("text/plain"));const to=idx;if(Number.isInteger(from)&&from!==to){const arr=t.roster;const moved=arr.splice(from,1)[0];arr.splice(to,0,moved);refreshRosterTable();saveAll();draw()}});
      el.rosterTableBody.appendChild(tr);
    });
  }

  // board
  function selectEleven(team){const roster=Array.isArray(team.roster)?team.roster:[];const first=roster.filter(p=>p.first==="FIRST");const subs=roster.filter(p=>p.first!=="FIRST");let pick=first.slice(0,11);if(pick.length<11){for(const s of subs){pick.push(s);if(pick.length===11)break}}const isGK=pl=>String(pl.pos||pl.name||"").toUpperCase()==="GK";if(!pick.some(isGK)){const gk=roster.find(isGK);if(gk){if(pick.length<11)pick.push(gk);else pick[pick.length-1]=gk}}return pick.slice(0,11)}
  function buildSlotsByCounts(players){const Y={GK:8,DF:22,MF:52,FW:84};const slots=[];slots.push({role:"GK",x:50,y:Y.GK});const counts={DF:0,MF:0,FW:0};players.forEach(p=>{const g=groupByPos(p.pos);if(g==="DF")counts.DF++;else if(g==="MF")counts.MF++;else if(g==="FW")counts.FW++});const dfXs=spacedXs(Math.max(1,counts.DF||4),68);dfXs.forEach(x=>slots.push({role:"DF",x,y:Y.DF}));const mfXs=spacedXs(Math.max(1,counts.MF||4),68);mfXs.forEach(x=>slots.push({role:"MF",x,y:Y.MF}));const fwXs=spacedXs(Math.max(1,counts.FW||2),44);fwXs.forEach(x=>slots.push({role:"FW",x,y:Y.FW}));return slots}
  function tokensForBoard(){const team=currentTeamObj();const picked=selectEleven(team);const slots=buildSlotsByCounts(picked);const used=new Set();const tokens=[];function takeGroup(G){for(let i=0;i<slots.length;i++){const s=slots[i];if(used.has(i))continue;if(s.role===G){used.add(i);return s}}return null}function takeNext(){for(let i=0;i<slots.length;i++){if(!used.has(i)){used.add(i);return slots[i]}}return{x:50,y:52,role:"MF"}}for(const p of picked){const grp=groupByPos(p.pos);let spot=takeGroup(grp);if(!spot)spot=takeNext();const x=(p.manualX!=null&&p.manualY!=null)?p.manualX:spot.x;const y=(p.manualX!=null&&p.manualY!=null)?p.manualY:spot.y;tokens.push({p,x,y})}return tokens}
  function fitCanvas(){const r=el.pitch.getBoundingClientRect();const dpr=Math.max(1,window.devicePixelRatio||1);el.pitch.width=Math.max(10,Math.floor(r.width*dpr));el.pitch.height=Math.max(10,Math.floor(r.height*dpr));ctx.setTransform(dpr,0,0,dpr,0,0)}
  function drawPitch(){const r=el.pitch.getBoundingClientRect();const w=Math.max(10,r.width),h=Math.max(10,r.height);ctx.clearRect(0,0,w,h);ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--pitch');ctx.fillRect(0,0,w,h);const line=getComputedStyle(document.documentElement).getPropertyValue('--line');ctx.strokeStyle=line;ctx.lineWidth=2;ctx.strokeRect(6,6,w-12,h-12);ctx.beginPath();ctx.moveTo(6,h/2);ctx.lineTo(w-6,h/2);ctx.stroke();ctx.beginPath();ctx.arc(w/2,h/2,Math.min(w,h)*0.09,0,Math.PI*2);ctx.stroke();const boxW=w*0.36,boxH=h*0.18;ctx.strokeRect(w/2-boxW/2,h-6-boxH,boxW,boxH);ctx.strokeRect(w/2-boxW/2,6,boxW,boxH);const sBoxW=w*0.18,sBoxH=h*0.08;ctx.strokeRect(w/2-sBoxW/2,h-6-sBoxH,sBoxW,sBoxH);ctx.strokeRect(w/2-sBoxW/2,6,sBoxW,sBoxH);ctx.beginPath();ctx.arc(w/2,h/2,3,0,Math.PI*2);ctx.fillStyle=line;ctx.fill()}
  function xyToCanvas(xPerc,yPerc){const r=el.pitch.getBoundingClientRect();const w=Math.max(10,r.width),h=Math.max(10,r.height);const x=xPerc/100*(w-24)+12;const y=h-(yPerc/100*(h-24)+12);return{x,y}}
  function canvasToXY(cx,cy){const r=el.pitch.getBoundingClientRect();const w=Math.max(10,r.width),h=Math.max(10,r.height);const xPerc=((cx-12)/(w-24))*100;const yPerc=((h-cy-12)/(h-24))*100;return{x:clamp(xPerc,0,100),y:clamp(yPerc,0,100)}}
  function drawPlayers(){const tokens=tokensForBoard();for(const tk of tokens){const {x,y}=xyToCanvas(tk.x,tk.y);const g=groupByPos(tk.p.pos);const color=(g==="GK")?"#21d07a":(g==="DF")?"#4da3ff":(g==="MF")?"#ffd24d":"#ff6f6f";ctx.beginPath();ctx.arc(x,y,20,0,Math.PI*2);ctx.fillStyle="rgba(0,0,0,.25)";ctx.fill();ctx.beginPath();ctx.arc(x,y-1,18,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();ctx.lineWidth=2;ctx.strokeStyle="rgba(255,255,255,.75)";ctx.stroke();let badge="";const t=(tk.p.type||"NORMAL");if(t==="ICON")badge=(tk.p.emoji||"⭐");else if(t==="TAEGUEK")badge=(tk.p.emoji||"🔹");else if(t==="AMIGO")badge=(tk.p.emoji||"🩶");else if(t==="FUTURE")badge=(tk.p.emoji||"💗");if(badge){ctx.font="18px 'Apple Color Emoji','Segoe UI Emoji',system-ui";ctx.textAlign="center";ctx.textBaseline="bottom";ctx.fillText(badge,x,y-22)}const nm=(tk.p.name||"").trim();ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillStyle="rgba(255,255,255,.95)";ctx.strokeStyle="rgba(0,0,0,.35)";ctx.lineWidth=3;ctx.strokeText(nm,x,y-1);ctx.fillText(nm,x,y-1)}}
  function draw(){drawPitch();drawPlayers();refreshSubsPanel()}
  let dragIndex=-1;function hitTest(mx,my){const tks=tokensForBoard();for(let i=tks.length-1;i>=0;i--){const {x,y}=xyToCanvas(tks[i].x,tks[i].y);const dx=mx-x,dy=my-y;if(dx*dx+dy*dy<=24*24)return i}return-1}
  function tokenRef(idx){const tks=tokensForBoard();if(idx<0||idx>=tks.length)return null;const tk=tks[idx];const team=currentTeamObj();const p=team.roster.find(pp=>pp===tk.p);return{tk,p}}
  el.pitch.addEventListener("mousedown",(e)=>{const r=el.pitch.getBoundingClientRect();const mx=(e.clientX-r.left),my=(e.clientY-r.top);dragIndex=hitTest(mx,my);if(dragIndex>=0)e.preventDefault()});
  window.addEventListener("mousemove",(e)=>{if(dragIndex<0)return;const r=el.pitch.getBoundingClientRect();const mx=(e.clientX-r.left),my=(e.clientY-r.top);const {x,y}=canvasToXY(mx,my);const ref=tokenRef(dragIndex);if(ref&&ref.p){ref.p.manualX=x;ref.p.manualY=y;saveAll();draw()}});
  window.addEventListener("mouseup",()=>{dragIndex=-1});

  // subs
  function refreshSubsPanel(){const team=currentTeamObj();const subs=(team.roster||[]).filter(p=>p.first!=="FIRST").slice(0,10);const tbody=document.querySelector("#subsTable tbody");if(!tbody)return;tbody.innerHTML="";if(subs.length===0){const tr=document.createElement('tr');const td=document.createElement('td');td.colSpan=4;td.textContent='SUB 명단이 비어 있습니다.';td.style.color='#8aa0b6';tr.appendChild(td);tbody.appendChild(tr);return}subs.forEach(p=>{const tr=document.createElement("tr");let mark="일반";if(p.type==="ICON")mark=(p.emoji||"⭐");else if(p.type==="TAEGUEK")mark=(p.emoji||"🔹");else if(p.type==="AMIGO")mark=(p.emoji||"🩶");else if(p.type==="FUTURE")mark=(p.emoji||"💗");tr.innerHTML=`<td>${(p.name||"")}</td><td>${(p.pos||"")}</td><td>${(p.ovr??"")}</td><td>${mark}</td>`;tbody.appendChild(tr)})}

  // export
  on(qs("#exportJsonBtn"),"click",()=>{const text=JSON.stringify(state,null,2);downloadBlob(new Blob([text],{type:"application/json"}),"team-state.json")});
  on(qs("#exportPngBtn"),"click",async()=>{fitCanvas();draw();const url=el.pitch.toDataURL("image/png");const res=await fetch(url);const blob=await res.blob();downloadBlob(blob,"formation.png")});

  // GitHub settings & save
  function getGhCfg(){return safeParse(localStorage.getItem(GH_KEY),{owner:"",repo:"",branch:"main",path:"data/default.json",token:""})}
  function setGhCfg(cfg){localStorage.setItem(GH_KEY,JSON.stringify(cfg))}
  function b64(str){return btoa(unescape(encodeURIComponent(str)))}
  async function githubGetSha(owner,repo,path,branch,token){const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;const resp=await fetch(url,{headers:{"Authorization":token?`Bearer ${token}`:undefined,"Accept":"application/vnd.github+json"}});if(resp.status===404)return null;if(!resp.ok)throw new Error(`GET ${resp.status}`);const js=await resp.json();return js.sha||null}
  async function githubPutFile(owner,repo,path,branch,token,contentText,message){const sha=await githubGetSha(owner,repo,path,branch,token);const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;const body={message,content:b64(contentText),branch};if(sha)body.sha=sha;const resp=await fetch(url,{method:"PUT",headers:{"Authorization":token?`Bearer ${token}`:undefined,"Accept":"application/vnd.github+json","Content-Type":"application/json"},body:JSON.stringify(body)});if(!resp.ok){const t=await resp.text();throw new Error(`PUT ${resp.status}: ${t}`)}return await resp.json()}
  function openSettingsModal(){const cfg=getGhCfg();qs("#ghOwner").value=cfg.owner||"";qs("#ghRepo").value=cfg.repo||"";qs("#ghBranch").value=cfg.branch||"main";qs("#ghPath").value=cfg.path||"data/default.json";qs("#ghToken").value=cfg.token||"";qs("#settingsModal").style.display="flex"}
  function closeSettingsModal(){qs("#settingsModal").style.display="none"}
  function saveSettings(){const cfg={owner:qs("#ghOwner").value.trim(),repo:qs("#ghRepo").value.trim(),branch:qs("#ghBranch").value.trim()||"main",path:qs("#ghPath").value.trim()||"data/default.json",token:qs("#ghToken").value.trim()};setGhCfg(cfg);closeSettingsModal();toast("GitHub 저장 설정 저장됨")}
  async function saveToGithub(){const cfg=getGhCfg();if(!cfg.owner||!cfg.repo||!cfg.branch||!cfg.path||!cfg.token){openSettingsModal();alert("GitHub 저장 설정을 먼저 입력하세요. (Owner/Repo/Branch/Path/Token)");return false}const contentText=JSON.stringify(state,null,2);const msg=`feat: save team-manager state (${new Date().toISOString()})`;try{await githubPutFile(cfg.owner,cfg.repo,cfg.path,cfg.branch,cfg.token,contentText,msg);toast("GitHub 저장 성공 ✓");return true}catch(e){alert("GitHub 저장 실패: "+e.message);return false}}
  on(qs("#openSettingsBtn"),"click",openSettingsModal);
  on(qs("#closeSettingsBtn"),"click",closeSettingsModal);
  on(qs("#saveSettingsBtn"),"click",saveSettings);
  on(qs("#saveToGithubBtn"),"click",async()=>{saveAll();await saveToGithub()});
  on(qs("#saveBtn"),"click",async()=>{saveAll();await saveToGithub()});
  window.addEventListener("keydown",async(e)=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){e.preventDefault();saveAll();await saveToGithub()}});

  // team ops
  function refreshPlayerSelect(){ensureDefaults();qs("#playerSelect").value=state.currentPlayer}
  function refreshTeamSelect(){ensureDefaults();const po=currentPlayerObj();const sel=qs("#teamSelect");sel.innerHTML="";const keys=Object.keys(po.teams||{});if(keys.length===0){po.teams["TEAM A"]=JSON.parse(JSON.stringify(defaultTeam));po.currentTeam="TEAM A"}for(const t of Object.keys(po.teams)){const opt=document.createElement("option");opt.value=t;opt.textContent=t;sel.appendChild(opt)}sel.value=po.currentTeam}
  on(qs("#playerSelect"),"change",()=>{state.currentPlayer=qs("#playerSelect").value;saveAll();refreshTeamSelect();refreshRosterTable();fitCanvas();draw()});
  on(qs("#teamSelect"),"change",()=>{const po=currentPlayerObj();po.currentTeam=qs("#teamSelect").value;saveAll();refreshRosterTable();fitCanvas();draw()});
  on(qs("#addTeamBtn"),"click",()=>{const po=currentPlayerObj();const name=prompt("새 팀 이름");if(!name)return;if(po.teams[name])return alert("이미 존재합니다.");po.teams[name]=JSON.parse(JSON.stringify(defaultTeam));po.currentTeam=name;saveAll();refreshTeamSelect();refreshRosterTable();fitCanvas();draw()});
  on(qs("#renameTeamBtn"),"click",()=>{const po=currentPlayerObj();const oldName=po.currentTeam;if(!oldName)return;const newName=prompt(`팀 이름 변경: '${oldName}' →`,oldName);if(!newName||newName===oldName)return;if(po.teams[newName]){alert("같은 이름의 팀이 이미 있습니다.");return}po.teams[newName]=po.teams[oldName];delete po.teams[oldName];po.currentTeam=newName;saveAll();refreshTeamSelect();refreshRosterTable();fitCanvas();draw()});
  on(qs("#deleteTeamBtn"),"click",()=>{const po=currentPlayerObj();const name=po.currentTeam;if(!confirm(`팀 '${name}' 삭제할까요?`))return;delete po.teams[name];po.currentTeam=Object.keys(po.teams)[0]||null;saveAll();refreshTeamSelect();refreshRosterTable();fitCanvas();draw()});

  // add/bulk players
  on(qs("#addPlayerBtn"),"click",()=>{const t=currentTeamObj();t.roster.push({name:"",pos:"DF",first:"SUB",ovr:70,type:"NORMAL",emoji:""});refreshRosterTable();saveAll();draw()});
  on(qs("#bulkAddBtn"),"click",()=>{const hint="한 줄에 한 명씩: 이름, 포지션(GK/DF/MF/FW), 구분(FIRST/SUB), 타입(NORMAL/ICON/TAEGUEK/AMIGO/FUTURE), (선택)이모지, (선택)OVR";const txt=prompt(hint,"");if(!txt)return;const t=currentTeamObj();txt.split(/
?
/).map(s=>s.trim()).filter(Boolean).forEach(line=>{const parts=line.split(/[	,]+|\s{2,}/).map(s=>s.trim());const [name,pos,first,type,emoji,ovr]=parts;const T=(type||"NORMAL").toUpperCase();let em=emoji||"";if(!em){if(T==="ICON")em="⭐";else if(T==="TAEGUEK")em="🔹";else if(T==="AMIGO")em="🩶";else if(T==="FUTURE")em="💗"}t.roster.push({name:name||"",pos:(pos||"DF").toUpperCase(),first:((first||"SUB").toUpperCase()==="FIRST"?"FIRST":"SUB"),type:T,emoji:em,ovr:Math.max(1,Math.min(99,Number(ovr)||70))})});refreshRosterTable();saveAll();draw()});

  // data banner & import/export
  function updateBanner(){ if(dataSource){ qs("#dataBanner").style.display='flex'; qs("#dataBannerText").textContent=`로컬스토리지 ← ${dataSource} 로드됨`; } else { qs("#dataBanner").style.display='none'; } }
  on(qs("#reloadDataBtn"),"click", async ()=>{ dataSource=null; const fetched=await tryAutoLoad(); if(fetched){ state=fetched; ensureDefaults(); saveAll(); refreshPlayerSelect(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw(); updateBanner(); } else { alert("data/default.json 또는 ?data= 로드 실패"); } });

  // start
  (async()=>{
    await initState(); ensureDefaults();
    refreshPlayerSelect(); refreshTeamSelect(); refreshRosterTable();
    fitCanvas(); draw(); updateBanner();
  })();
});
</script>
</body>
</html>
