<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Team Manager · Formation Board v8.4.1</title>
<link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml" />
<style>
  :root{ --bg:#0b111a; --panel:#121a24; --muted:#8aa0b6; --text:#e9eef6; --accent:#4da3ff; --pitch:#146c43; --line:#e6f3e9; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple Color Emoji","Segoe UI Emoji";}
  header{display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:12px 16px; border-bottom:1px solid #1b2531; background:#0e1522; position:sticky; top:0; z-index:3;}
  header h1{font-size:16px; margin:0 6px 0 0; font-weight:700; letter-spacing:.2px}
  .pill{padding:8px 10px; background:var(--panel); border:1px solid #1e2a37; border-radius:10px; display:flex; align-items:center; gap:8px}
  select,input{background:#0f1622; color:var(--text); border:1px solid #293748; border-radius:8px; padding:7px 9px; outline:none}
  select:focus,input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(77,163,255,.14)}
  button{ background:#162336; color:#e6f0ff; border:1px solid #2a3a54; border-radius:8px; padding:8px 12px; cursor:pointer; }
  button:hover{filter:brightness(1.08)} button.ghost{background:transparent; border-color:#3a4a61; color:#cfd9ee}
  button.warn{background:#3f2c00; border-color:#5d4300; color:#ffd98b} button.good{background:#063d2a; border-color:#0f6; color:#c1ffdf}
  main{display:grid; grid-template-columns: 1.05fr 880px; gap:14px; padding:14px} @media (max-width:1260px){ main{grid-template-columns:1fr} }
  .card{ background:var(--panel); border:1px solid #1c2633; border-radius:14px; overflow:hidden; }
  .card header{background:transparent; border-bottom:1px solid #1c2633; padding:10px 12px} .card header h2{font-size:14px; margin:0; opacity:.92}
  .card .body{padding:12px} .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .muted{color:var(--muted)} .sep{height:1px; background:#1c2633; margin:10px 0}
  table{width:100%; border-collapse:collapse; table-layout:fixed}
  th,td{border-bottom:1px dashed #263346; padding:6px 6px; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  th{font-weight:600; color:#cdd7e6} tr:hover td{background:#0f1722} td input, td select{width:100%}
  #pitchWrap{position:relative; aspect-ratio:105/68; background:var(--pitch); border:1px solid #0f422b; border-radius:14px; overflow:hidden}
  canvas{display:block; width:100%; height:100%}
  .drag{cursor:grab; user-select:none; color:#aab6c8} .drag:active{cursor:grabbing}
  .banner{background:#0f1b2b; border:1px solid #203149; color:#b7c8e6; padding:6px 10px; border-radius:10px; display:flex; align-items:center; gap:8px}
  .banner small{opacity:.85}
  .w-num{width:42px; text-align:center} .w-ovr{width:80px} .w-name{width:210px} .w-pos{width:120px} .w-first{width:110px} .w-type{width:200px} .w-del{width:40px; text-align:center}
  .typeWrap{display:flex; gap:6px; align-items:center} .emoji{width:52px}
</style>
</head>
<body>
<header>
  <h1>Team Manager · Formation Board v8.4.1</h1>
  <div class="pill">
    <span class="muted">플레이어</span>
    <select id="playerSelect"><option>JUNIBAR</option><option>D0PAM1NE</option></select>
  </div>
  <div class="pill">
    <span class="muted">팀</span>
    <select id="teamSelect"></select>
    <button id="addTeamBtn">팀 추가</button>
    <button id="renameTeamBtn" class="ghost">이름 변경</button>
    <button id="deleteTeamBtn" class="warn">삭제</button>
  </div>
  <div class="pill">
    <button id="exportPngBtn">PNG 내보내기</button>
    <button id="exportJsonBtn" class="ghost">JSON 내보내기</button>
    <label class="pill small" for="importJsonInput" style="cursor:pointer">JSON 불러오기</label>
    <input id="importJsonInput" type="file" accept="application/json" style="display:none" />
  </div>
  <div id="dataBanner" class="banner" style="margin-left:auto; display:none;">
    <span>📦</span><span id="dataBannerText"></span>
    <button id="reloadDataBtn" class="ghost" style="margin-left:8px;">데이터 다시 불러오기</button>
  </div>
</header>

<main>
  <section id="left" class="card">
    <header><h2>로스터</h2></header>
    <div class="body">
      <div class="row small"><span class="muted">구분 <b>FIRST/SUB</b>. 선발에서 <b>아이콘 ≤ 2</b>, <b>태극 ≤ 2</b>. 타입: 일반/아이콘/태극/아미고/퓨쳐. 기본 이모지: ⭐/🔹/🩶/💗</span></div>
      <div class="sep"></div>
      <table id="rosterTable">
        <thead>
          <tr>
            <th class="w-del">⇅</th><th class="w-num">번호</th><th class="w-name">이름</th><th class="w-ovr">OVR</th>
            <th class="w-pos">포지션</th><th class="w-first">구분</th><th class="w-type">선수 타입</th><th class="w-del">-</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="sep"></div>
      <div class="row"><button id="addPlayerBtn">선수 추가</button><button id="bulkAddBtn" class="ghost">대량 추가</button></div>
    </div>
  </section>

  <section id="center" class="card">
    <header><h2>전술 보드</h2></header>
    <div class="body">
      <div id="pitchWrap"><canvas id="pitch"></canvas></div>
      <div class="sep"></div>
      <div id="subsPanel">
        <div id="subsToolbar" style="display:flex; gap:8px; align-items:center; justify-content:flex-start; margin:0 0 8px 0;">
          <button id="saveBtn" class="good">저장</button>
          <button id="clearManualBtn" class="ghost">수동 위치 초기화</button>
          <button id="forceReflowBtn" class="ghost">강제 재배치</button>
        </div>
        <h3 style="margin:4px 0 8px 0; font-size:13px; color:#cdd7e6">SUB 명단 (드래그로 순서 변경 · 최대 10명)</h3>
        <table id="subsTable">
          <thead><tr><th style="width:8%">⇅</th><th style="width:36%">이름</th><th style="width:18%">포지션</th><th style="width:18%">OVR</th><th style="width:20%">선수타입</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
const TYPE_LABEL = { NORMAL:"일반", ICON:"아이콘", TAEGUEK:"태극", AMIGO:"아미고", FUTURE:"퓨쳐" };
const LS_KEY = "tm_v8_4_1";
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function groupByPos(pos){ pos=(pos||"").toUpperCase(); if(pos==="GK") return "GK"; if(pos==="DF") return "DF"; if(pos==="MF") return "MF"; if(pos==="FW") return "FW"; return "DF"; }
function spacedXs(n, widthPct){ widthPct = clamp(widthPct, 0, 82); const xs=[]; const center=50, half=widthPct/2; for(let i=0;i<n;i++){ const t=(n===1)?0.5:i/(n-1); xs.push(Math.round((center-half)+widthPct*t)); } return xs; }
function safeParse(json, fallback){ try{ const v=JSON.parse(json); return v??fallback; }catch{ return fallback; } }
function getQuery(name){ const u=new URL(location.href); return u.searchParams.get(name); }

const defaultTeam = { roster:[
  {name:"GK", pos:"GK", first:"FIRST", ovr:72, type:"NORMAL", emoji:""},
  {name:"RB", pos:"DF", first:"FIRST", ovr:70, type:"NORMAL", emoji:""},
  {name:"RCB", pos:"DF", first:"FIRST", ovr:70, type:"NORMAL", emoji:""},
  {name:"LCB", pos:"DF", first:"FIRST", ovr:70, type:"NORMAL", emoji:""},
  {name:"LB", pos:"DF", first:"FIRST", ovr:70, type:"NORMAL", emoji:""},
  {name:"RM", pos:"MF", first:"SUB", ovr:72, type:"NORMAL", emoji:""},
  {name:"CM", pos:"MF", first:"SUB", ovr:73, type:"ICON", emoji:"⭐"},
  {name:"LM", pos:"MF", first:"FIRST", ovr:72, type:"TAEGUEK", emoji:"🔹"},
  {name:"RF", pos:"FW", first:"SUB", ovr:74, type:"NORMAL", emoji:""},
  {name:"LF", pos:"FW", first:"SUB", ovr:74, type:"AMIGO", emoji:"🩶"},
  {name:"ST", pos:"FW", first:"FIRST", ovr:70, type:"FUTURE", emoji:"💗"}
]};

function buildDefaultState(){
  return { players: { "JUNIBAR": { teams: { "TEAM A": JSON.parse(JSON.stringify(defaultTeam)) }, currentTeam:"TEAM A" }, "D0PAM1NE": { teams: { "TEAM B": JSON.parse(JSON.stringify(defaultTeam)) }, currentTeam:"TEAM B" } }, currentPlayer: "JUNIBAR" };
}

function loadAll(){ return safeParse(localStorage.getItem(LS_KEY), null); }
function saveAll(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

// Auto-load (?data or /data/default.json)
let dataSource = null;
async function tryAutoLoad(){
  const override = getQuery("data");
  const candidates = [ override, "data/default.json" ].filter(Boolean);
  for(const url of candidates){
    try{
      const resp = await fetch(url, {cache:"no-store"});
      if(!resp.ok) continue;
      const js = await resp.json();
      if(js && js.players){
        localStorage.setItem(LS_KEY, JSON.stringify(js));
        dataSource = url;
        return js;
      }
    }catch (e){ /* ignore */ }
  }
  return null;
}

let state = null;
async function initState(){
  const needReload = getQuery("reload")==="1";
  let ls = loadAll();
  if(needReload || !ls){
    const fetched = await tryAutoLoad();
    if(fetched){ state = fetched; return; }
  }
  if(!ls){
    const legacy = safeParse(localStorage.getItem("tm_v8_4"), null);
    if(legacy && legacy.players){ localStorage.setItem(LS_KEY, JSON.stringify(legacy)); ls = legacy; }
  }
  if(!ls){ ls = buildDefaultState(); localStorage.setItem(LS_KEY, JSON.stringify(ls)); }
  state = ls;
}

function ensureDefaults(){
  if(!state.players) state.players={};
  if(!state.players["JUNIBAR"]) state.players["JUNIBAR"] = { teams:{}, currentTeam:null };
  if(!state.players["D0PAM1NE"]) state.players["D0PAM1NE"] = { teams:{}, currentTeam:null };
  if(!state.currentPlayer || !state.players[state.currentPlayer]) state.currentPlayer="JUNIBAR";
  for(const u of Object.keys(state.players)){
    const po=state.players[u]; if(!po.teams || typeof po.teams!=="object") po.teams={};
    if(Object.keys(po.teams).length===0){ po.teams["TEAM A"]=JSON.parse(JSON.stringify(defaultTeam)); po.currentTeam="TEAM A"; }
    if(!po.currentTeam || !po.teams[po.currentTeam]) po.currentTeam=Object.keys(po.teams)[0];
  }
}

function currentPlayerObj(){ return state.players[state.currentPlayer]; }
function currentTeamObj(){ const p=currentPlayerObj(); return p.teams[p.currentTeam]; }

const playerSelect = document.getElementById("playerSelect");
const teamSelect = document.getElementById("teamSelect");
const rosterTableBody = document.querySelector("#rosterTable tbody");
const pitch = document.getElementById("pitch");
const ctx = pitch.getContext("2d");
const dataBanner = document.getElementById("dataBanner");
const dataBannerText = document.getElementById("dataBannerText");

function countStarterType(team, t){ return (team.roster||[]).filter(p=>p.first==="FIRST" && (p.type||"NORMAL")===t).length; }
function countTypeAll(team, t){ return (team.roster||[]).filter(p=> (p.type||"NORMAL")===t).length; }
function enforceTypeLimit(team, next){
  if(next==="ICON" && countStarterType(team,"ICON")>=2) return false;
  if(next==="TAEGUEK" && countStarterType(team,"TAEGUEK")>=2) return false;
  if(next==="FUTURE" && countTypeAll(team,"FUTURE")>=1) return false; // team-wide unique
  return true;
}

function refreshRosterTable(){
  const team=currentTeamObj(); rosterTableBody.innerHTML="";
  (team.roster||[]).forEach((p,idx)=>{
    const tr=document.createElement("tr"); tr.draggable=true;
    tr.innerHTML=`
      <td class="drag w-del" title="드래그로 순서 조정">≡</td>
      <td class="w-num">${idx+1}</td>
      <td class="w-name"><input type="text" value="${p.name??""}"></td>
      <td class="w-ovr"><input type="number" min="1" max="99" value="${(p.ovr??70)}"></td>
      <td class="w-pos">
        <select><option value="GK">GK</option><option value="DF">DF</option><option value="MF">MF</option><option value="FW">FW</option></select>
      </td>
      <td class="w-first"><select><option value="FIRST">FIRST</option><option value="SUB">SUB</option></select></td>
      <td class="w-type">
        <div class="typeWrap">
          <select class="ptypeSel">
            <option value="NORMAL">일반</option>
            <option value="ICON">아이콘</option>
            <option value="TAEGUEK">태극</option>
            <option value="AMIGO">아미고</option>
            <option value="FUTURE">퓨쳐</option>
          </select>
          <input class="emoji" type="text" maxlength="2" placeholder="⭐/🔹/🩶/💗" />
        </div>
      </td>
      <td class="w-del"><button class="ghost">-</button></td>`;
    const nameEl=tr.children[2].firstElementChild;
    const ovrEl=tr.children[3].firstElementChild;
    const posSel=tr.children[4].firstElementChild;
    const firstSel=tr.children[5].firstElementChild;
    const typeSel=tr.querySelector(".ptypeSel");
    const emojiEl=tr.querySelector(".emoji");
    const delBtn=tr.children[7].firstElementChild;

    posSel.value=p.pos||"DF";
    if(p.ovr==null){ p.ovr=70; } ovrEl.value=p.ovr;
    firstSel.value=p.first||"SUB";
    typeSel.value=p.type||"NORMAL";
    if(!p.emoji){
      if(p.type==="ICON") p.emoji="⭐";
      else if(p.type==="TAEGUEK") p.emoji="🔹";
      else if(p.type==="AMIGO") p.emoji="🩶";
      else if(p.type==="FUTURE") p.emoji="💗";
    }
    emojiEl.value=p.emoji||"";
    emojiEl.style.display=(typeSel.value==="ICON"||typeSel.value==="TAEGUEK"||typeSel.value==="AMIGO"||typeSel.value==="FUTURE")?"block":"none";

    nameEl.addEventListener("input",()=>{ p.name=nameEl.value; saveAll(); draw(); });
    ovrEl.addEventListener("change",()=>{ p.ovr=Math.max(1,Math.min(99,Number(ovrEl.value)||70)); saveAll(); draw(); });
    posSel.addEventListener("change",()=>{ p.pos=posSel.value; saveAll(); draw(); });
    firstSel.addEventListener("change",()=>{ p.first=firstSel.value; saveAll(); draw(); });
    typeSel.addEventListener("change",()=>{
      const before=p.type||"NORMAL"; const next=typeSel.value;
      if(p.first==="FIRST" && !enforceTypeLimit(team,next)){ 
        if(next==="ICON"||next==="TAEGUEK"){ alert(`선발 라인에 '${TYPE_LABEL[next]}' 타입은 최대 2명입니다.`); typeSel.value=before; return; }
      }
      if(next==="FUTURE" && countTypeAll(currentTeamObj(),"FUTURE")>=1 && before!=="FUTURE"){ alert("퓨쳐는 팀당 한 명만 가능합니다."); typeSel.value=before; return; }
      p.type=next;
      if(next==="ICON" && !p.emoji){ p.emoji="⭐"; }
      if(next==="TAEGUEK" && !p.emoji){ p.emoji="🔹"; }
      if(next==="AMIGO" && !p.emoji){ p.emoji="🩶"; }
      if(next==="FUTURE" && !p.emoji){ p.emoji="💗"; }
      emojiEl.style.display=(next==="ICON"||next==="TAEGUEK"||next==="AMIGO"||next==="FUTURE")?"block":"none";
      emojiEl.value=p.emoji||"";
      saveAll(); draw();
    });
    emojiEl.addEventListener("input",()=>{ p.emoji=emojiEl.value; saveAll(); draw(); });
    delBtn.addEventListener("click",()=>{ team.roster.splice(idx,1); refreshRosterTable(); saveAll(); draw(); });

    // Drag reorder (main roster table)
    tr.addEventListener("dragstart",(e)=>{ e.dataTransfer.setData("text/plain", String(idx)); tr.style.opacity=.5; });
    tr.addEventListener("dragend",()=>{ tr.style.opacity=""; });
    tr.addEventListener("dragover",(e)=>{ e.preventDefault(); tr.style.outline="1px dashed #3a4a66"; });
    tr.addEventListener("dragleave",()=>{ tr.style.outline=""; });
    tr.addEventListener("drop",(e)=>{
      e.preventDefault(); tr.style.outline="";
      const from=Number(e.dataTransfer.getData("text/plain")); const to=idx;
      if(Number.isInteger(from) && from!==to){ const arr=team.roster; const moved=arr.splice(from,1)[0]; arr.splice(to,0,moved); refreshRosterTable(); saveAll(); draw(); }
    });
    rosterTableBody.appendChild(tr);
  });
}

function selectEleven(team){
  const roster = Array.isArray(team.roster)? team.roster : [];
  const first = roster.filter(p=>p.first==="FIRST");
  const subs  = roster.filter(p=>p.first!=="FIRST");
  let pick = first.slice(0, 11);
  if(pick.length < 11){ for(const s of subs){ pick.push(s); if(pick.length===11) break; } }
  const isGK = pl => String(pl.pos||pl.name||"").toUpperCase()==="GK";
  if(!pick.some(isGK)){ const gk = roster.find(isGK); if(gk){ if(pick.length<11) pick.push(gk); else pick[pick.length-1]=gk; } }
  return pick.slice(0,11);
}

function buildSlotsByCounts(players){
  const Y = { GK:8, DF:22, MF:52, FW:84 };
  const slots=[];
  slots.push({role:"GK", x:50, y:Y.GK});
  const counts = { DF:0, MF:0, FW:0 };
  players.forEach(p=>{ const g=groupByPos(p.pos); if(g==="DF") counts.DF++; else if(g==="MF") counts.MF++; else if(g==="FW") counts.FW++; });
  const dfXs = spacedXs(Math.max(1,counts.DF||4), 68); dfXs.forEach(x=>slots.push({role:"DF", x, y:Y.DF}));
  const mfXs = spacedXs(Math.max(1,counts.MF||4), 68); mfXs.forEach(x=>slots.push({role:"MF", x, y:Y.MF}));
  const fwXs = spacedXs(Math.max(1,counts.FW||2), 44); fwXs.forEach(x=>slots.push({role:"FW", x, y:Y.FW}));
  return slots;
}

function tokensForBoard(){
  const team=currentTeamObj();
  const picked = selectEleven(team);
  const slots = buildSlotsByCounts(picked);
  const used = new Set(); const tokens=[];
  function takeGroup(G){ for(let i=0;i<slots.length;i++){ const s=slots[i]; if(used.has(i)) continue; if(s.role===G){ used.add(i); return s; } } return null; }
  function takeNext(){ for(let i=0;i<slots.length;i++){ if(!used.has(i)){ used.add(i); return slots[i]; } } return {x:50,y:52,role:"MF"}; }
  for(const p of picked){
    const grp = groupByPos(p.pos);
    let spot = takeGroup(grp);
    if(!spot) spot = takeNext();
    const x = (p.manualX!=null && p.manualY!=null) ? p.manualX : spot.x;
    const y = (p.manualX!=null && p.manualY!=null) ? p.manualY : spot.y;
    tokens.push({p,x,y});
  }
  return tokens;
}

function fitCanvas(){ const r=pitch.getBoundingClientRect(); const dpr=Math.max(1, window.devicePixelRatio||1); pitch.width=Math.max(10, Math.floor(r.width*dpr)); pitch.height=Math.max(10, Math.floor(r.height*dpr)); ctx.setTransform(dpr,0,0,dpr,0,0); }
function drawPitch(){ const r=pitch.getBoundingClientRect(); const w=Math.max(10,r.width), h=Math.max(10,r.height);
  ctx.clearRect(0,0,w,h); ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--pitch'); ctx.fillRect(0,0,w,h);
  const line=getComputedStyle(document.documentElement).getPropertyValue('--line'); ctx.strokeStyle=line; ctx.lineWidth=2;
  ctx.strokeRect(6,6,w-12,h-12); ctx.beginPath(); ctx.moveTo(6,h/2); ctx.lineTo(w-6,h/2); ctx.stroke();
  ctx.beginPath(); ctx.arc(w/2,h/2,Math.min(w,h)*0.09,0,Math.PI*2); ctx.stroke();
  const boxW=w*0.36, boxH=h*0.18; ctx.strokeRect(w/2-boxW/2,h-6-boxH,boxW,boxH); ctx.strokeRect(w/2-boxW/2,6,boxW,boxH);
  const sBoxW=w*0.18, sBoxH=h*0.08; ctx.strokeRect(w/2-sBoxW/2,h-6-sBoxH,sBoxW,sBoxH); ctx.strokeRect(w/2-sBoxW/2,6,sBoxW,sBoxH);
  ctx.beginPath(); ctx.arc(w/2,h/2,3,0,Math.PI*2); ctx.fillStyle=line; ctx.fill();
}
function xyToCanvas(xPerc,yPerc){ const r=pitch.getBoundingClientRect(); const w=Math.max(10,r.width), h=Math.max(10,r.height); const x=xPerc/100*(w-24)+12; const y=h-(yPerc/100*(h-24)+12); return {x,y}; }
function canvasToXY(cx,cy){ const r=pitch.getBoundingClientRect(); const w=Math.max(10,r.width), h=Math.max(10,r.height); const xPerc=((cx-12)/(w-24))*100; const yPerc=((h-cy-12)/(h-24))*100; return {x:clamp(xPerc,0,100), y:clamp(yPerc,0,100)}; }
function drawPlayers(){
  const tokens=tokensForBoard();
  for(const tk of tokens){
    const {x,y}=xyToCanvas(tk.x, tk.y);
    const g= groupByPos(tk.p.pos);
    const color = (g==="GK")?"#21d07a":(g==="DF")?"#4da3ff":(g==="MF")?"#ffd24d":"#ff6f6f";
    ctx.beginPath(); ctx.arc(x,y,20,0,Math.PI*2); ctx.fillStyle="rgba(0,0,0,.25)"; ctx.fill();
    ctx.beginPath(); ctx.arc(x,y-1,18,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle="rgba(255,255,255,.75)"; ctx.stroke();
    let badge=""; const t=(tk.p.type||"NORMAL");
    if(t==="ICON") badge=(tk.p.emoji||"⭐");
    else if(t==="TAEGUEK") badge=(tk.p.emoji||"🔹");
    else if(t==="AMIGO") badge=(tk.p.emoji||"🩶");
    else if(t==="FUTURE") badge=(tk.p.emoji||"💗");
    if(badge){ ctx.font="18px 'Apple Color Emoji','Segoe UI Emoji',system-ui"; ctx.textAlign="center"; ctx.textBaseline="bottom"; ctx.fillText(badge, x, y-22); }
    const nm=(tk.p.name||"").trim(); ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillStyle="rgba(255,255,255,.95)";
    ctx.strokeStyle="rgba(0,0,0,.35)"; ctx.lineWidth=3; ctx.strokeText(nm, x, y-1); ctx.fillText(nm, x, y-1);
  }
}
function draw(){ drawPitch(); drawPlayers(); refreshSubsPanel(); }

let dragIndex=-1;
function hitTest(mx,my){ const tks=tokensForBoard(); for(let i=tks.length-1;i>=0;i--){ const {x,y}=xyToCanvas(tks[i].x,tks[i].y); const dx=mx-x, dy=my-y; if(dx*dx+dy*dy<=24*24) return i; } return -1; }
function tokenRef(idx){ const tks=tokensForBoard(); if(idx<0||idx>=tks.length) return null; const tk=tks[idx]; const team=currentTeamObj(); const p=team.roster.find(pp=>pp===tk.p); return {tk,p}; }
pitch.addEventListener("mousedown",(e)=>{ const r=pitch.getBoundingClientRect(); const mx=(e.clientX-r.left), my=(e.clientY-r.top); dragIndex=hitTest(mx,my); if(dragIndex>=0) e.preventDefault(); });
window.addEventListener("mousemove",(e)=>{ if(dragIndex<0) return; const r=pitch.getBoundingClientRect(); const mx=(e.clientX-r.left), my=(e.clientY-r.top); const {x,y}=canvasToXY(mx,my); const ref=tokenRef(dragIndex); if(ref&&ref.p){ ref.p.manualX=x; ref.p.manualY=y; saveAll(); draw(); } });
window.addEventListener("mouseup",()=>{ dragIndex=-1; });

// ---- SUB 패널: 드래그 정렬 ----
function refreshSubsPanel(){
  const team=currentTeamObj();
  const subs=(team.roster||[]).filter(p=>p.first!=="FIRST");
  const tbody=document.querySelector("#subsTable tbody"); if(!tbody) return; tbody.innerHTML="";
  if(subs.length===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=5; td.textContent='SUB 명단이 비어 있습니다.'; td.style.color='#8aa0b6'; tr.appendChild(td); tbody.appendChild(tr); return; }
  subs.forEach((p, localIdx)=>{
    const tr=document.createElement("tr"); tr.draggable=true;
    let mark="일반"; if(p.type==="ICON") mark=(p.emoji||"⭐"); else if(p.type==="TAEGUEK") mark=(p.emoji||"🔹"); else if(p.type==="AMIGO") mark=(p.emoji||"🩶"); else if(p.type==="FUTURE") mark=(p.emoji||"💗");
    tr.innerHTML = `<td class="drag">≡</td><td>${(p.name||"")}</td><td>${(p.pos||"")}</td><td>${(p.ovr??"")}</td><td>${mark}</td>`;

    // DnD within subs: reorder in the main roster while keeping only SUB section reordered
    tr.addEventListener("dragstart",(e)=>{ e.dataTransfer.setData("text/plain", String(localIdx)); tr.style.opacity=.5; });
    tr.addEventListener("dragend",()=>{ tr.style.opacity=""; });
    tr.addEventListener("dragover",(e)=>{ e.preventDefault(); tr.style.outline="1px dashed #3a4a66"; });
    tr.addEventListener("dragleave",()=>{ tr.style.outline=""; });
    tr.addEventListener("drop",(e)=>{
      e.preventDefault(); tr.style.outline="";
      const fromLocal=Number(e.dataTransfer.getData("text/plain")); const toLocal=localIdx;
      if(Number.isInteger(fromLocal) && fromLocal!==toLocal){
        // compute global roster indices of SUBs
        const roster=currentTeamObj().roster;
        const subsGlobalIdx = roster.map((pp,i)=> pp.first!=="FIRST" ? i : -1).filter(i=>i>=0);
        const fromGlobal = subsGlobalIdx[fromLocal];
        const toGlobal = subsGlobalIdx[toLocal];
        const moved = roster.splice(fromGlobal,1)[0];
        // recompute subsGlobalIdx after splice effect if needed
        const subsGlobalIdxAfter = roster.map((pp,i)=> pp.first!=="FIRST" ? i : -1).filter(i=>i>=0);
        const insertAt = subsGlobalIdxAfter[toLocal] ?? roster.length;
        roster.splice(insertAt, 0, moved);
        saveAll(); refreshSubsPanel(); refreshRosterTable(); draw();
      }
    });

    tbody.appendChild(tr);
  });
}

// ---- Export: JSON & PNG (filename prompt) ----
function downloadBlob(blob, filename){
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
}
function exportJSON(){
  const defName = prompt("저장할 JSON 파일명(확장자 포함)", "team-state.json");
  if(!defName) return;
  const text = JSON.stringify(state, null, 2);
  const blob = new Blob([text], {type:"application/json"});
  downloadBlob(blob, defName);
}
async function exportPNG(){
  // Ensure canvas is up to date
  fitCanvas(); draw();
  const defName = prompt("저장할 PNG 파일명(확장자 포함)", "formation.png");
  if(!defName) return;
  const url = pitch.toDataURL("image/png");
  const res = await fetch(url);
  const blob = await res.blob();
  downloadBlob(blob, defName);
}

// ---- Team add/delete/rename ----
function renameCurrentTeam(){
  const po=currentPlayerObj();
  const oldName = po.currentTeam;
  if(!oldName) return;
  const newName = prompt(`팀 이름 변경: '${oldName}' →`, oldName);
  if(!newName || newName===oldName) return;
  if(po.teams[newName]){ alert("같은 이름의 팀이 이미 있습니다."); return; }
  // Move data under new key
  po.teams[newName] = po.teams[oldName];
  delete po.teams[oldName];
  po.currentTeam = newName;
  saveAll(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw();
}

document.getElementById("saveBtn").addEventListener("click",()=>{ saveAll(); const btn=document.getElementById("saveBtn"); const t=btn.textContent; btn.textContent="저장됨 ✓"; setTimeout(()=>btn.textContent=t,900); });
document.getElementById("clearManualBtn").addEventListener("click",()=>{ const t=currentTeamObj(); for(const p of t.roster){ delete p.manualX; delete p.manualY; } saveAll(); draw(); });
document.getElementById("forceReflowBtn").addEventListener("click",()=>{ draw(); });

document.getElementById("exportJsonBtn").addEventListener("click", exportJSON);
document.getElementById("exportPngBtn").addEventListener("click", exportPNG);

document.getElementById("reloadDataBtn").addEventListener("click", async ()=>{
  dataSource=null;
  const fetched = await tryAutoLoad();
  if(fetched){ state=fetched; ensureDefaults(); saveAll(); refreshPlayerSelect(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw(); updateBanner(); }
  else{ alert("data/default.json 또는 ?data= 로드 실패"); }
});

const playerSelectEl = document.getElementById("playerSelect");
const teamSelectEl = document.getElementById("teamSelect");
playerSelectEl.addEventListener("change",()=>{ state.currentPlayer = playerSelectEl.value; saveAll(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw(); });
document.getElementById("addTeamBtn").addEventListener("click",()=>{
  const po=currentPlayerObj(); const name=prompt("새 팀 이름"); if(!name) return; if(po.teams[name]) return alert("이미 존재합니다.");
  po.teams[name]=JSON.parse(JSON.stringify(defaultTeam)); po.currentTeam=name; saveAll(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw();
});
document.getElementById("renameTeamBtn").addEventListener("click", renameCurrentTeam);
document.getElementById("deleteTeamBtn").addEventListener("click",()=>{
  const po=currentPlayerObj(); const name=po.currentTeam; if(!confirm(`팀 '${name}' 삭제할까요?`)) return;
  delete po.teams[name]; po.currentTeam=Object.keys(po.teams)[0]||null; saveAll(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw();
});
teamSelectEl.addEventListener("change",()=>{ const po=currentPlayerObj(); po.currentTeam=teamSelectEl.value; saveAll(); refreshRosterTable(); fitCanvas(); draw(); });

document.getElementById("addPlayerBtn").addEventListener("click",()=>{
  const t=currentTeamObj(); t.roster.push({name:"",pos:"DF",first:"SUB",ovr:70,type:"NORMAL",emoji:""});
  refreshRosterTable(); saveAll(); draw();
});
document.getElementById("bulkAddBtn").addEventListener("click",()=>{
  const hint="한 줄에 한 명씩: 이름, OVR, 포지션(GK/DF/MF/FW), 구분(FIRST/SUB), 타입(NORMAL/ICON/TAEGUEK/AMIGO/FUTURE),\n예)\nHaaland, 91, FW, FIRST";
  const txt=prompt(hint,""); if(!txt) return; const t=currentTeamObj();
  txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).forEach(line=>{
    const parts=line.split(/[\t,]+|\s{2,}/).map(s=>s.trim());
    const [name,pos,first,type,emoji,ovr] = parts;
    const T=(type||"NORMAL").toUpperCase();
    if(T==="FUTURE" && countTypeAll(currentTeamObj(), "FUTURE") >= 1){ alert("FUTURE(퓨쳐)는 팀당 한 명만 가능합니다. 해당 줄은 건너뜁니다: "+(name||"")); return; }
    let em = emoji||""; if(!em){ if(T==="ICON") em="⭐"; else if(T==="TAEGUEK") em="🔹"; else if(T==="AMIGO") em="🩶"; else if(T==="FUTURE") em="💗"; }
    t.roster.push({name:name||"", pos:(pos||"DF").toUpperCase(), first:((first||"SUB").toUpperCase()==="FIRST"?"FIRST":"SUB"),
      type:T, emoji:em, ovr: Math.max(1,Math.min(99, Number(ovr)||70)) });
  });
  refreshRosterTable(); saveAll(); draw();
});

function refreshPlayerSelect(){ ensureDefaults(); playerSelectEl.value = state.currentPlayer; }
function refreshTeamSelect(){
  ensureDefaults(); const po=currentPlayerObj(); teamSelectEl.innerHTML=""; const keys=Object.keys(po.teams||{});
  if(keys.length===0){ po.teams["TEAM A"]=JSON.parse(JSON.stringify(defaultTeam)); po.currentTeam="TEAM A"; }
  for(const t of Object.keys(po.teams)){ const opt=document.createElement("option"); opt.value=t; opt.textContent=t; teamSelectEl.appendChild(opt); }
  teamSelectEl.value = po.currentTeam;
}

function updateBanner(){ if(dataSource){ dataBanner.style.display='flex'; dataBannerText.textContent=`로컬스토리지 ← ${dataSource} 로드됨`; } else { dataBanner.style.display='none'; } }

async function boot(){
  await initState();
  ensureDefaults();
  refreshPlayerSelect();
  refreshTeamSelect();
  refreshRosterTable();
  fitCanvas(); draw();
  updateBanner();
}
window.addEventListener("load", boot);
window.addEventListener("resize", ()=>{ fitCanvas(); draw(); });
</script>
</body>
</html>
