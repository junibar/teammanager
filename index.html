<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>íŒ€ ê´€ë¦¬ Â· í¬ë©”ì´ì…˜ ë³´ë“œ v8.3</title>
<style>
  :root{ --bg:#0b111a; --panel:#121a24; --muted:#8aa0b6; --text:#e9eef6; --accent:#4da3ff; --pitch:#146c43; --line:#e6f3e9; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple Color Emoji","Segoe UI Emoji";}
  header{display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:12px 16px; border-bottom:1px solid #1b2531; background:#0e1522; position:sticky; top:0; z-index:3;}
  header h1{font-size:16px; margin:0 6px 0 0; font-weight:700; letter-spacing:.2px}
  .pill{padding:8px 10px; background:var(--panel); border:1px solid #1e2a37; border-radius:10px; display:flex; align-items:center; gap:8px}
  select,input{background:#0f1622; color:var(--text); border:1px solid #293748; border-radius:8px; padding:7px 9px; outline:none}
  select:focus,input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(77,163,255,.14)}
  button{ background:#162336; color:#e6f0ff; border:1px solid #2a3a54; border-radius:8px; padding:8px 12px; cursor:pointer; }
  button:hover{filter:brightness(1.08)} button.ghost{background:transparent; border-color:#3a4a61; color:#cfd9ee}
  button.warn{background:#3f2c00; border-color:#5d4300; color:#ffd98b} button.good{background:#063d2a; border-color:#0f6; color:#c1ffdf}
  main{display:grid; grid-template-columns: 1.05fr 880px; gap:14px; padding:14px} @media (max-width:1260px){ main{grid-template-columns:1fr} }
  .card{ background:var(--panel); border:1px solid #1c2633; border-radius:14px; overflow:hidden; }
  .card header{background:transparent; border-bottom:1px solid #1c2633; padding:10px 12px} .card header h2{font-size:14px; margin:0; opacity:.92}
  .card .body{padding:12px} .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .muted{color:var(--muted)} .sep{height:1px; background:#1c2633; margin:10px 0}
  table{width:100%; border-collapse:collapse; table-layout:fixed}
  th,td{border-bottom:1px dashed #263346; padding:6px 6px; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  th{font-weight:600; color:#cdd7e6} tr:hover td{background:#0f1722} td input, td select{width:100%}
  #pitchWrap{position:relative; aspect-ratio:105/68; background:var(--pitch); border:1px solid #0f422b; border-radius:14px; overflow:hidden}
  canvas{display:block; width:100%; height:100%}
  .drag{cursor:grab; user-select:none; color:#aab6c8} .drag:active{cursor:grabbing}
  .w-num{width:42px; text-align:center} .w-ovr{width:80px} .w-name{width:210px} .w-pos{width:120px} .w-first{width:110px} .w-type{width:200px} .w-del{width:40px; text-align:center}
  .typeWrap{display:flex; gap:6px; align-items:center} .emoji{width:52px}
</style>
</head>
<body>
<header>
  <h1>íŒ€ ê´€ë¦¬ Â· í¬ë©”ì´ì…˜ ë³´ë“œ v8.3</h1>
  <div class="pill">
    <span class="muted">í”Œë ˆì´ì–´</span>
    <select id="playerSelect"><option>JUNIBAR</option><option>D0PAM1NE</option></select>
  </div>
  <div class="pill">
    <span class="muted">íŒ€</span>
    <select id="teamSelect"></select>
    <button id="addTeamBtn">íŒ€ ì¶”ê°€</button>
    <button id="deleteTeamBtn" class="warn">ì‚­ì œ</button>
  </div>
  <div class="pill">
    <button id="exportPngBtn">PNG ë‚´ë³´ë‚´ê¸°</button>
    <button id="exportJsonBtn" class="ghost">JSON ë‚´ë³´ë‚´ê¸°</button>
    <label class="pill small" for="importJsonInput" style="cursor:pointer">JSON ë¶ˆëŸ¬ì˜¤ê¸°</label>
    <input id="importJsonInput" type="file" accept="application/json" style="display:none" />
  </div>
</header>

<main>
  <section id="left" class="card">
    <header><h2>ë¡œìŠ¤í„°</h2></header>
    <div class="body">
      <div class="row small"><span class="muted">êµ¬ë¶„: <b>FIRST/SUB</b>. ì„ ë°œì—ì„œ <b>ì•„ì´ì½˜ â‰¤ 2</b>, <b>íƒœê·¹ â‰¤ 2</b>. <b>FUTURE</b>ëŠ” íŒ€ë‹¹ 1ëª… ì œí•œ.</span></div>
      <div class="sep"></div>
      <table id="rosterTable">
        <thead>
          <tr>
            <th class="w-del">â‡…</th><th class="w-num">ë²ˆí˜¸</th><th class="w-name">ì´ë¦„</th><th class="w-ovr">OVR</th>
            <th class="w-pos">í¬ì§€ì…˜</th><th class="w-first">êµ¬ë¶„</th><th class="w-type">ì„ ìˆ˜ íƒ€ì…</th><th class="w-del">-</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="sep"></div>
      <div class="row"><button id="addPlayerBtn">ì„ ìˆ˜ ì¶”ê°€</button><button id="bulkAddBtn" class="ghost">ëŒ€ëŸ‰ ì¶”ê°€</button></div>
    </div>
  </section>

  <section id="center" class="card">
    <header><h2>ì „ìˆ  ë³´ë“œ</h2></header>
    <div class="body">
      <div id="pitchWrap"><canvas id="pitch"></canvas></div>
      <div class="sep"></div>
      <div id="subsPanel">
        <div id="subsToolbar" style="display:flex; gap:8px; align-items:center; justify-content:flex-start; margin:0 0 8px 0;">
          <button id="saveBtn" class="good">ì €ì¥</button>
          <button id="clearManualBtn" class="ghost">ìˆ˜ë™ ìœ„ì¹˜ ì´ˆê¸°í™”</button>
          <button id="forceReflowBtn" class="ghost">ê°•ì œ ì¬ë°°ì¹˜</button>
        </div>
        <h3 style="margin:4px 0 8px 0; font-size:13px; color:#cdd7e6">SUB ëª…ë‹¨ (ìµœëŒ€ 10ëª…)</h3>
        <table id="subsTable">
          <thead><tr><th style="width:40%">ì´ë¦„</th><th style="width:20%">í¬ì§€ì…˜</th><th style="width:20%">OVR</th><th style="width:20%">ì„ ìˆ˜íƒ€ì…</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
const TYPE_LABEL = { NORMAL:"ì¼ë°˜", ICON:"ì•„ì´ì½˜", TAEGUEK:"íƒœê·¹", AMIGO:"ì•„ë¯¸ê³ ", FUTURE:"í“¨ì²˜" };
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function roleGroupByNameOrPos(name,pos){
  const hint=(name||"").toUpperCase();
  if(hint==="GK") return "GK";
  if(["LB","RB","CB","LCB","RCB","LWB","RWB"].includes(hint)) return "DF";
  if(["LM","RM","CM","CAM","CDM","RCM","LCM","RAM","LAM"].includes(hint)) return "MF";
  if(["LW","RW","ST","CF","RF","LF"].includes(hint)) return "FW";
  const p=(pos||"").toUpperCase();
  if(["GK","DF","MF","FW"].includes(p)) return p;
  return "MF";
}
function placeLine(n, y, widthPct){ widthPct = clamp(widthPct,0,82); const xs=[]; const center=50, half=widthPct/2; for(let i=0;i<n;i++){ const t=(n===1)?0.5:i/(n-1); xs.push(Math.round((center-half)+widthPct*t)); } return xs.map(x=>({x,y})); }

const defaultTeam = { roster:[
  {name:"GK", pos:"GK", first:"FIRST", ovr:72, type:"NORMAL", emoji:""},
  {name:"RB", pos:"DF", first:"FIRST", ovr:70, type:"NORMAL", emoji:""},
  {name:"RCB", pos:"DF", first:"FIRST", ovr:70, type:"NORMAL", emoji:""},
  {name:"LCB", pos:"DF", first:"FIRST", ovr:70, type:"NORMAL", emoji:""},
  {name:"LB", pos:"DF", first:"FIRST", ovr:70, type:"NORMAL", emoji:""},
  {name:"RM", pos:"MF", first:"SUB", ovr:72, type:"NORMAL", emoji:""},
  {name:"CM", pos:"MF", first:"SUB", ovr:73, type:"ICON", emoji:"â­"},
  {name:"LM", pos:"MF", first:"FIRST", ovr:72, type:"TAEGUEK", emoji:"ğŸ”¹"},
  {name:"RF", pos:"FW", first:"SUB", ovr:74, type:"NORMAL", emoji:""},
  {name:"LF", pos:"FW", first:"SUB", ovr:74, type:"AMIGO", emoji:"ğŸ©¶"},
  {name:"Sub", pos:"FW", first:"FIRST", ovr:70, type:"FUTURE", emoji:"ğŸ’—"}
]};
function safeParse(json, fallback){ try{ const v=JSON.parse(json); return v??fallback; }catch{ return fallback; } }
function loadAll(){ const raw = localStorage.getItem("tm_v8_3"); const base = safeParse(raw, null);
  if(!base || typeof base!=="object" || !base.players){
    return { players: { "JUNIBAR": { teams: { "TEAM A": JSON.parse(JSON.stringify(defaultTeam)) }, currentTeam:"TEAM A" }, "D0PAM1NE": { teams: { "TEAM B": JSON.parse(JSON.stringify(defaultTeam)) }, currentTeam:"TEAM B" } }, currentPlayer: "JUNIBAR" };
  } return base;
}
const state = loadAll();
function ensureDefaults(){
  if(!state.players) state.players={};
  if(!state.players["JUNIBAR"]) state.players["JUNIBAR"] = { teams:{}, currentTeam:null };
  if(!state.players["D0PAM1NE"]) state.players["D0PAM1NE"] = { teams:{}, currentTeam:null };
  if(!state.currentPlayer || !state.players[state.currentPlayer]) state.currentPlayer="JUNIBAR";
  for(const u of Object.keys(state.players)){
    const po=state.players[u]; if(!po.teams || typeof po.teams!=="object") po.teams={};
    if(Object.keys(po.teams).length===0){ po.teams["TEAM A"]=JSON.parse(JSON.stringify(defaultTeam)); po.currentTeam="TEAM A"; }
    if(!po.currentTeam || !po.teams[po.currentTeam]) po.currentTeam=Object.keys(po.teams)[0];
  }
}
function saveAll(){ localStorage.setItem("tm_v8_3", JSON.stringify(state)); }
function currentPlayerObj(){ return state.players[state.currentPlayer]; }
function currentTeamObj(){ const p=currentPlayerObj(); return p.teams[p.currentTeam]; }

const playerSelect = document.getElementById("playerSelect");
const teamSelect = document.getElementById("teamSelect");
const rosterTableBody = document.querySelector("#rosterTable tbody");
const pitch = document.getElementById("pitch");
const ctx = pitch.getContext("2d");

function countStarterType(team, t){ return (team.roster||[]).filter(p=>p.first==="FIRST" && (p.type||"NORMAL")===t).length; }
function countTeamType(team, t){ return (team.roster||[]).filter(p=>(p.type||"NORMAL")===t).length; }
function enforceTypeLimitStarter(team, next){
  if(next==="ICON" && countStarterType(team,"ICON")>=2) return false;
  if(next==="TAEGUEK" && countStarterType(team,"TAEGUEK")>=2) return false;
  return true;
}

function refreshRosterTable(){
  const team=currentTeamObj(); rosterTableBody.innerHTML="";
  (team.roster||[]).forEach((p,idx)=>{
    const tr=document.createElement("tr"); tr.draggable=true;
    tr.innerHTML=`
      <td class="drag w-del" title="ë“œë˜ê·¸ë¡œ ìˆœì„œ ì¡°ì •">â‰¡</td>
      <td class="w-num">${idx+1}</td>
      <td class="w-name"><input type="text" value="${p.name??""}"></td>
      <td class="w-ovr"><input type="number" min="1" max="99" value="${(p.ovr??70)}"></td>
      <td class="w-pos">
        <select><option value="GK">GK</option><option value="DF">DF</option><option value="MF">MF</option><option value="FW">FW</option></select>
      </td>
      <td class="w-first"><select><option value="FIRST">FIRST</option><option value="SUB">SUB</option></select></td>
      <td class="w-type">
        <div class="typeWrap">
          <select class="ptypeSel">
            <option value="NORMAL">ì¼ë°˜</option>
            <option value="ICON">ì•„ì´ì½˜</option>
            <option value="TAEGUEK">íƒœê·¹</option>
            <option value="AMIGO">ì•„ë¯¸ê³ </option>
            <option value="FUTURE">FUTURE</option>
          </select>
          <input class="emoji" type="text" maxlength="2" placeholder="â­/ğŸ”¹/ğŸ©¶/ğŸ’—" />
        </div>
      </td>
      <td class="w-del"><button class="ghost">-</button></td>`;
    const nameEl=tr.children[2].firstElementChild;
    const ovrEl=tr.children[3].firstElementChild;
    const posSel=tr.children[4].firstElementChild;
    const firstSel=tr.children[5].firstElementChild;
    const typeSel=tr.querySelector(".ptypeSel");
    const emojiEl=tr.querySelector(".emoji");
    const delBtn=tr.children[7].firstElementChild;

    posSel.value=(p.pos||"DF").toUpperCase();
    if(p.ovr==null){ p.ovr=70; } ovrEl.value=p.ovr;
    firstSel.value=p.first||"SUB";
    typeSel.value=p.type||"NORMAL";
    if(!p.emoji){
      if(p.type==="ICON") p.emoji="â­";
      else if(p.type==="TAEGUEK") p.emoji="ğŸ”¹";
      else if(p.type==="AMIGO") p.emoji="ğŸ©¶";
      else if(p.type==="FUTURE") p.emoji="ğŸ’—";
    }
    emojiEl.value=p.emoji||"";
    emojiEl.style.display=(["ICON","TAEGUEK","AMIGO","FUTURE"].includes(typeSel.value))?"block":"none";

    nameEl.addEventListener("input",()=>{ p.name=nameEl.value; saveAll(); draw(); });
    ovrEl.addEventListener("change",()=>{ p.ovr=Math.max(1,Math.min(99,Number(ovrEl.value)||70)); saveAll(); draw(); });
    posSel.addEventListener("change",()=>{ p.pos=posSel.value; saveAll(); draw(); });
    firstSel.addEventListener("change",()=>{ p.first=firstSel.value; saveAll(); draw(); });
    typeSel.addEventListener("change",()=>{
      const before=p.type||"NORMAL"; const next=typeSel.value;
      // FUTURE: team-wide max 1 (across FIRST/SUB)
      if(next==="FUTURE"){
        const cnt=countTeamType(team,"FUTURE");
        if(cnt>=1 && before!=="FUTURE"){ alert("FUTURE íƒ€ì…ì€ íŒ€ë‹¹ 1ëª…ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); typeSel.value=before; return; }
      }
      // ICON/TAEGUEK: starter limit
      if(p.first==="FIRST" && !enforceTypeLimitStarter(team,next)){ alert(`ì„ ë°œ ë¼ì¸ì— '${TYPE_LABEL[next]}' íƒ€ì…ì€ ìµœëŒ€ 2ëª…ì…ë‹ˆë‹¤.`); typeSel.value=before; return; }
      p.type=next;
      if(next==="ICON" && !p.emoji){ p.emoji="â­"; }
      if(next==="TAEGUEK" && !p.emoji){ p.emoji="ğŸ”¹"; }
      if(next==="AMIGO" && !p.emoji){ p.emoji="ğŸ©¶"; }
      if(next==="FUTURE" && !p.emoji){ p.emoji="ğŸ’—"; }
      emojiEl.style.display=(["ICON","TAEGUEK","AMIGO","FUTURE"].includes(next))?"block":"none";
      emojiEl.value=p.emoji||"";
      saveAll(); draw();
    });
    emojiEl.addEventListener("input",()=>{ p.emoji=emojiEl.value; saveAll(); draw(); });
    delBtn.addEventListener("click",()=>{ team.roster.splice(idx,1); refreshRosterTable(); saveAll(); draw(); });

    tr.addEventListener("dragstart",(e)=>{ e.dataTransfer.setData("text/plain", String(idx)); tr.style.opacity=.5; });
    tr.addEventListener("dragend",()=>{ tr.style.opacity=""; });
    tr.addEventListener("dragover",(e)=>{ e.preventDefault(); tr.style.outline="1px dashed #3a4a66"; });
    tr.addEventListener("dragleave",()=>{ tr.style.outline=""; });
    tr.addEventListener("drop",(e)=>{
      e.preventDefault(); tr.style.outline="";
      const from=Number(e.dataTransfer.getData("text/plain")); const to=idx;
      if(Number.isInteger(from) && from!==to){ const arr=team.roster; const moved=arr.splice(from,1)[0]; arr.splice(to,0,moved); refreshRosterTable(); saveAll(); draw(); }
    });
    rosterTableBody.appendChild(tr);
  });
}

function selectEleven(team){
  const roster = Array.isArray(team.roster)? team.roster : [];
  const first = roster.filter(p=>p.first==="FIRST");
  const subs  = roster.filter(p=>p.first!=="FIRST");
  let pick = first.slice(0, 11);
  if(pick.length < 11){ for(const s of subs){ pick.push(s); if(pick.length===11) break; } }
  const isGK = pl => String((pl.name||pl.pos||"")).toUpperCase()==="GK";
  if(!pick.some(isGK)){ const gk = roster.find(isGK); if(gk){ if(pick.length<11) pick.push(gk); else pick[pick.length-1]=gk; } }
  return pick.slice(0,11);
}

function buildAutoSlots(players){
  const Y = { GK:8, DEF:22, MID:52, ST:84 };
  const groups = players.map(p=>roleGroupByNameOrPos(p.name,p.pos));
  const gkN = groups.filter(g=>g==="GK").length || 1;
  const dfN = Math.max(3, groups.filter(g=>g==="DF").length || 3);
  const mfN = Math.max(3, groups.filter(g=>g==="MF").length || 3);
  const fwN = Math.max(2, groups.filter(g=>g==="FW").length || 2);

  const slots=[];
  slots.push(...placeLine(gkN, Y.GK, 0));
  slots.push(...placeLine(dfN, 22, dfN===3?52:70));
  slots.push(...placeLine(mfN, Y.MID, mfN===3?60:76));
  slots.push(...placeLine(fwN, Y.ST, fwN===2?44:66));
  return slots;
}

function tokensForBoard(){
  const team=currentTeamObj();
  const picked = selectEleven(team);
  const slots = buildAutoSlots(picked);
  const used = new Set(); const tokens=[];
  function takeNext(){ for(let i=0;i<slots.length;i++){ if(!used.has(i)){ used.add(i); return slots[i]; } } return {x:50,y:52,role:"VIRT"}; }
  for(const p of picked){
    const spot=takeNext();
    const x = (p.manualX!=null && p.manualY!=null) ? p.manualX : spot.x;
    const y = (p.manualX!=null && p.manualY!=null) ? p.manualY : spot.y;
    tokens.push({p,x,y});
  }
  return tokens;
}

/* canvas */
function fitCanvas(){ const r=pitch.getBoundingClientRect(); const dpr=Math.max(1, window.devicePixelRatio||1); pitch.width=Math.max(10, Math.floor(r.width*dpr)); pitch.height=Math.max(10, Math.floor(r.height*dpr)); ctx.setTransform(dpr,0,0,dpr,0,0); }
function drawPitch(){ const r=pitch.getBoundingClientRect(); const w=Math.max(10,r.width), h=Math.max(10,r.height);
  ctx.clearRect(0,0,w,h); ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--pitch'); ctx.fillRect(0,0,w,h);
  const line=getComputedStyle(document.documentElement).getPropertyValue('--line'); ctx.strokeStyle=line; ctx.lineWidth=2;
  ctx.strokeRect(6,6,w-12,h-12); ctx.beginPath(); ctx.moveTo(6,h/2); ctx.lineTo(w-6,h/2); ctx.stroke();
  ctx.beginPath(); ctx.arc(w/2,h/2,Math.min(w,h)*0.09,0,Math.PI*2); ctx.stroke();
  const boxW=w*0.36, boxH=h*0.18; ctx.strokeRect(w/2-boxW/2,h-6-boxH,boxW,boxH); ctx.strokeRect(w/2-boxW/2,6,boxW,boxH);
  const sBoxW=w*0.18, sBoxH=h*0.08; ctx.strokeRect(w/2-sBoxW/2,h-6-sBoxH,sBoxW,sBoxH); ctx.strokeRect(w/2-sBoxW/2,6,sBoxW,sBoxH);
  ctx.beginPath(); ctx.arc(w/2,h/2,3,0,Math.PI*2); ctx.fillStyle=line; ctx.fill();
}
function xyToCanvas(xPerc,yPerc){ const r=pitch.getBoundingClientRect(); const w=Math.max(10,r.width), h=Math.max(10,r.height); const x=xPerc/100*(w-24)+12; const y=h-(yPerc/100*(h-24)+12); return {x,y}; }
function canvasToXY(cx,cy){ const r=pitch.getBoundingClientRect(); const w=Math.max(10,r.width), h=Math.max(10,r.height); const xPerc=((cx-12)/(w-24))*100; const yPerc=((h-cy-12)/(h-24))*100; return {x:clamp(xPerc,0,100), y:clamp(yPerc,0,100)}; }
function drawPlayers(){
  const tokens=tokensForBoard();
  for(const tk of tokens){
    const {x,y}=xyToCanvas(tk.x, tk.y);
    const g= roleGroupByNameOrPos(tk.p.name, tk.p.pos);
    const color = (g==="GK")?"#21d07a":(g==="DF")?"#4da3ff":(g==="MF")?"#ffd24d":"#ff6f6f";
    ctx.beginPath(); ctx.arc(x,y,20,0,Math.PI*2); ctx.fillStyle="rgba(0,0,0,.25)"; ctx.fill();
    ctx.beginPath(); ctx.arc(x,y-1,18,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle="rgba(255,255,255,.75)"; ctx.stroke();
    let badge=""; const t=(tk.p.type||"NORMAL");
    if(t==="ICON") badge=(tk.p.emoji||"â­");
    else if(t==="TAEGUEK") badge=(tk.p.emoji||"ğŸ”¹");
    else if(t==="AMIGO") badge=(tk.p.emoji||"ğŸ©¶");
    else if(t==="FUTURE") badge=(tk.p.emoji||"ğŸ’—");
    if(badge){ ctx.font="18px 'Apple Color Emoji','Segoe UI Emoji',system-ui"; ctx.textAlign="center"; ctx.textBaseline="bottom"; ctx.fillText(badge, x, y-22); }
    const nm=(tk.p.name||"").trim(); ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillStyle="rgba(255,255,255,.95)";
    ctx.strokeStyle="rgba(0,0,0,.35)"; ctx.lineWidth=3; ctx.strokeText(nm, x, y-1); ctx.fillText(nm, x, y-1);
  }
}
function draw(){ drawPitch(); drawPlayers(); refreshSubsPanel(); }

/* drag */
let dragIndex=-1;
function hitTest(mx,my){ const tks=tokensForBoard(); for(let i=tks.length-1;i>=0;i--){ const {x,y}=xyToCanvas(tks[i].x,tks[i].y); const dx=mx-x, dy=my-y; if(dx*dx+dy*dy<=24*24) return i; } return -1; }
function tokenRef(idx){ const tks=tokensForBoard(); if(idx<0||idx>=tks.length) return null; const tk=tks[idx]; const team=currentTeamObj(); const p=team.roster.find(pp=>pp===tk.p); return {tk,p}; }
pitch.addEventListener("mousedown",(e)=>{ const r=pitch.getBoundingClientRect(); const mx=(e.clientX-r.left), my=(e.clientY-r.top); dragIndex=hitTest(mx,my); if(dragIndex>=0) e.preventDefault(); });
window.addEventListener("mousemove",(e)=>{ if(dragIndex<0) return; const r=pitch.getBoundingClientRect(); const mx=(e.clientX-r.left), my=(e.clientY-r.top); const {x,y}=canvasToXY(mx,my); const ref=tokenRef(dragIndex); if(ref&&ref.p){ ref.p.manualX=x; ref.p.manualY=y; saveAll(); draw(); } });
window.addEventListener("mouseup",()=>{ dragIndex=-1; });

/* subs */
function refreshSubsPanel(){
  const team=currentTeamObj();
  const subs=(team.roster||[]).filter(p=>p.first!=="FIRST").slice(0,10);
  const tbody=document.querySelector("#subsTable tbody"); if(!tbody) return; tbody.innerHTML="";
  if(subs.length===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=4; td.textContent='SUB ëª…ë‹¨ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'; td.style.color='#8aa0b6'; tr.appendChild(td); tbody.appendChild(tr); return; }
  subs.forEach(p=>{
    const tr=document.createElement("tr");
    let typeLabel="ì¼ë°˜";
    if(p.type==="ICON") typeLabel=(p.emoji||"â­");
    else if(p.type==="TAEGUEK") typeLabel=(p.emoji||"ğŸ”¹");
    else if(p.type==="AMIGO") typeLabel=(p.emoji||"ğŸ©¶");
    else if(p.type==="FUTURE") typeLabel=(p.emoji||"ğŸ’—");
    tr.innerHTML = `<td>${(p.name||"")}</td><td>${(p.pos||"")}</td><td>${(p.ovr??"")}</td><td>${typeLabel}</td>`;
    tbody.appendChild(tr);
  });
}

/* toolbar & header */
document.getElementById("saveBtn").addEventListener("click",()=>{ saveAll(); const btn=document.getElementById("saveBtn"); const t=btn.textContent; btn.textContent="ì €ì¥ë¨ âœ“"; setTimeout(()=>btn.textContent=t,900); });
document.getElementById("clearManualBtn").addEventListener("click",()=>{ const t=currentTeamObj(); for(const p of t.roster){ delete p.manualX; delete p.manualY; } saveAll(); draw(); });
document.getElementById("forceReflowBtn").addEventListener("click",()=>{ draw(); });

const playerSelectEl = document.getElementById("playerSelect");
const teamSelectEl = document.getElementById("teamSelect");
playerSelectEl.addEventListener("change",()=>{ state.currentPlayer = playerSelectEl.value; saveAll(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw(); });
document.getElementById("addTeamBtn").addEventListener("click",()=>{ const po=currentPlayerObj(); const name=prompt("ìƒˆ íŒ€ ì´ë¦„"); if(!name) return; if(po.teams[name]) return alert("ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."); po.teams[name]=JSON.parse(JSON.stringify(defaultTeam)); po.currentTeam=name; saveAll(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw(); });
document.getElementById("deleteTeamBtn").addEventListener("click",()=>{ const po=currentPlayerObj(); const name=po.currentTeam; if(!confirm(`íŒ€ '${name}' ì‚­ì œí• ê¹Œìš”?`)) return; delete po.teams[name]; po.currentTeam=Object.keys(po.teams)[0]||null; saveAll(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw(); });
teamSelectEl.addEventListener("change",()=>{ const po=currentPlayerObj(); po.currentTeam=teamSelectEl.value; saveAll(); refreshRosterTable(); fitCanvas(); draw(); });

document.getElementById("addPlayerBtn").addEventListener("click",()=>{ const t=currentTeamObj(); t.roster.push({name:"",pos:"DF",first:"SUB",ovr:70,type:"NORMAL",emoji:""}); refreshRosterTable(); saveAll(); draw(); });
document.getElementById("bulkAddBtn").addEventListener("click",()=>{
  const hint="í•œ ì¤„ì— í•œ ëª…ì”©: ì´ë¦„, í¬ì§€ì…˜(GK/DF/MF/FW), êµ¬ë¶„(FIRST/SUB), íƒ€ì…(NORMAL/ICON/TAEGUEK/AMIGO/FUTURE), (ì„ íƒ)ì´ëª¨ì§€(â­/ğŸ”¹/ğŸ©¶/ğŸ’—), (ì„ íƒ)OVR";
  const txt=prompt(hint,""); if(!txt) return; const t=currentTeamObj();
  txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).forEach(line=>{
    const parts=line.split(/[\t,]+|\s{2,}/).map(s=>s.trim());
    const [name,pos,first,type,emoji,ovr] = parts;
    const T=(type||"").toUpperCase();
    // FUTURE limit check during bulk add
    if(T==="FUTURE"){
      const cnt=(t.roster||[]).filter(x=>(x.type||"NORMAL")==="FUTURE").length;
      if(cnt>=1){ return; } // skip extra FUTURE entries
    }
    let defaultEmoji="";
    if(T==="ICON") defaultEmoji="â­";
    else if(T==="TAEGUEK") defaultEmoji="ğŸ”¹";
    else if(T==="AMIGO") defaultEmoji="ğŸ©¶";
    else if(T==="FUTURE") defaultEmoji="ğŸ’—";
    t.roster.push({name:name||"", pos:(pos||"DF").toUpperCase(), first:((first||"SUB").toUpperCase()==="FIRST"?"FIRST":"SUB"),
      type:T||"NORMAL", emoji:emoji or defaultEmoji, ovr: Math.max(1,Math.min(99, Number(ovr)||70)) });
  }); refreshRosterTable(); saveAll(); draw();
});

function refreshTeamSelect(){ ensureDefaults(); const po=currentPlayerObj(); teamSelectEl.innerHTML=""; const keys=Object.keys(po.teams||{});
  if(keys.length===0){ po.teams["TEAM A"]=JSON.parse(JSON.stringify(defaultTeam)); po.currentTeam="TEAM A"; }
  for(const t of Object.keys(po.teams)){ const opt=document.createElement("option"); opt.value=t; opt.textContent=t; teamSelectEl.appendChild(opt); } teamSelectEl.value = po.currentTeam; }
function refreshPlayerSelect(){ ensureDefaults(); playerSelectEl.value = state.currentPlayer; }

function boot(){ ensureDefaults(); refreshPlayerSelect(); refreshTeamSelect(); refreshRosterTable(); fitCanvas(); draw(); }
window.addEventListener("load", boot); window.addEventListener("resize", ()=>{ fitCanvas(); draw(); });
</script>
</body>
</html>
